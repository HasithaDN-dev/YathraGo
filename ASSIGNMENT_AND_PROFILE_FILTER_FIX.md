# Assignment and Profile Filter Fix

## Summary
Fixed two critical issues in the ride request negotiation system:
1. Assignment logic now **automatically** populates ChildRideRequest/StaffRideRequest tables when anyone accepts
2. Customer app now filters ride requests by active profile instead of showing all profiles' requests

---

## Backend Changes

### File: `backend/src/driver-request/driver-request.service.ts`

#### Fixed Issue: Assignment Not Happening Automatically

**Problem**: 
- When negotiation was accepted, the system only updated askDriverRequest status to ACCEPTED
- The assignRequest method existed but was NEVER called automatically
- Data was NOT being sent to ChildRideRequest or StaffRideRequest tables
- Manual API call to `/driver-request/:id/assign` was required (but never documented)

**Solution**: Made assignment automatic by adding `await this.assignRequest(requestId)` in two places:

1. **`respondRequest` method** - When driver accepts (action = 'ACCEPT')
2. **`acceptRequest` method** - When customer accepts

#### Fixed: `assignRequest` Method
**Problem**: When assignRequest was called, it was:
- Setting status to 'Pending' instead of 'Assigned'
- Not populating the AssignedDate field
- Missing updatedAt for StaffRideRequest

**Solution**: Updated the assignment logic to properly set all fields:

```typescript
// Create ChildRideRequest or StaffRideRequest
if (request.staffOrChild === 'child') {
  await this.prisma.childRideRequest.create({
    data: {
      childId: request.staffOrChildID,
      driverId: request.driverId,
      Amount: request.currentAmount,
      status: 'Assigned',              // ✅ Changed from 'Pending'
      AssignedDate: new Date(),         // ✅ Added
    },
  });
} else {
  await this.prisma.staffRideRequest.create({
    data: {
      staffId: request.staffOrChildID,
      driverId: request.driverId,
      Amount: request.currentAmount,
      status: 'Assigned',              // ✅ Changed from 'Pending'
      AssignedDate: new Date(),         // ✅ Added
      updatedAt: new Date(),            // ✅ Added (required for StaffRideRequest)
    },
  });
}
```

**Fields Populated**:
- ✅ `childId` or `staffId` - Profile identifier
- ✅ `driverId` - Assigned driver
- ✅ `Amount` - Final negotiated amount (currentAmount from negotiation)
- ✅ `status` - Set to 'Assigned' (RequestStatus enum)
- ✅ `AssignedDate` - Current timestamp
- ✅ `updatedAt` - Current timestamp (StaffRideRequest only, as it doesn't have @updatedAt decorator)
- ⚙️ `createdAt` - Auto-generated by Prisma (@default(now()))
- ⚙️ `id` - Auto-generated by Prisma (@id @default(autoincrement()))

**Note**: The difference between ChildRideRequest and StaffRideRequest:
- `ChildRideRequest.updatedAt` has `@updatedAt` decorator → Auto-managed by Prisma
- `StaffRideRequest.updatedAt` lacks decorator → Must be provided manually

---

## Frontend Changes

### File: `mobile-customer/app/(menu)/find-driver/request-list.tsx`

#### Fixed: Profile-Based Request Filtering

**Problem**: The customer app was displaying all ride requests for the customer across all profiles (children and staff), regardless of which profile was currently active.

**Solution**: Added filtering logic to show only requests for the active profile.

**Changes**:

1. **Import active profile from store**:
```typescript
const { customerProfile, activeProfile } = useProfileStore();
```

2. **Filter requests by active profile**:
```typescript
const loadRequests = async () => {
  try {
    if (!customerProfile) {
      Alert.alert('Error', 'Profile not found');
      return;
    }
    const data = await driverRequestApi.getCustomerRequests(customerProfile.customer_id);
    
    // Filter requests by active profile
    const filteredData = activeProfile 
      ? data.filter(request => {
          // Parse the profileId from the id string (format: "child-123" or "staff-456")
          const profileIdStr = activeProfile.id.split('-')[1];
          const profileId = parseInt(profileIdStr, 10);
          return request.profileType === activeProfile.type && request.profileId === profileId;
        })
      : data;
    
    setRequests(filteredData);
  } catch (error) {
    console.error('Load requests error:', error);
    Alert.alert('Error', 'Failed to load requests');
  } finally {
    setLoading(false);
    setRefreshing(false);
  }
};
```

3. **Reload on profile change**:
```typescript
useEffect(() => {
  loadRequests();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [activeProfile]); // Now reloads when active profile changes
```

**Filter Logic**:
- Extracts numeric ID from activeProfile.id (format: "child-123" → 123)
- Compares both `profileType` ('child' or 'staff') and `profileId` (numeric ID)
- Only shows requests matching current active profile
- Falls back to showing all requests if no active profile is set

---

**Code Changes**:

```typescript
// In respondRequest method (driver accepts)
if (dto.action === 'ACCEPT') {
  await this.assignRequest(requestId);  // ✅ Added
}

// In acceptRequest method (customer accepts)
await this.assignRequest(requestId);  // ✅ Added
```

Now when **anyone** accepts (driver OR customer), the data is automatically sent to the ride tables!

---

## Data Flow

### When Negotiation is Accepted:

1. **Driver/Customer accepts an offer** → Backend calls `respondRequest` or `acceptRequest`
2. **Status updated** → askDriverRequest.status = ACCEPTED
3. **Auto-assignment triggered** → `assignRequest` is automatically called
4. **Backend creates record**:
   ```
   ChildRideRequest or StaffRideRequest
   ├── childId/staffId: From request.staffOrChildID
   ├── driverId: From request.driverId
   ├── Amount: From request.currentAmount (final negotiated price)
   ├── status: 'Assigned'
   ├── AssignedDate: Current timestamp
   └── updatedAt: Current timestamp (StaffRideRequest only)
   ```
3. **Backend updates negotiation status**:
   ```
   askDriverRequest.status → ASSIGNED
   ```

### When Customer Views Requests:

1. **Customer has multiple profiles** (e.g., Child A, Child B, Staff Member)
2. **Customer selects active profile** → Updates `activeProfile` in store
3. **Request list loads** → Fetches all customer's requests from backend
4. **Frontend filters** → Shows only requests for active profile
5. **Profile change** → Automatically reloads and re-filters

---

## Testing

### Test Assignment Logic:

1. **Send a ride request** from customer to driver
2. **Negotiate** (optional counter-offers)
3. **Accept the offer** (either party)
4. **Check database**:
   ```sql
   -- For child requests
   SELECT * FROM "ChildRideRequest" 
   WHERE "childId" = [profile_id] AND "driverId" = [driver_id]
   ORDER BY "createdAt" DESC LIMIT 1;
   
   -- For staff requests
   SELECT * FROM "StaffRideRequest" 
   WHERE "staffId" = [profile_id] AND "driverId" = [driver_id]
   ORDER BY "createdAt" DESC LIMIT 1;
   ```
5. **Verify fields**:
   - ✅ status = 'Assigned'
   - ✅ Amount = final negotiated amount
   - ✅ AssignedDate = timestamp
   - ✅ All other fields populated

### Test Profile Filtering:

1. **Login as customer** with multiple profiles
2. **Send requests** for different profiles (Child A, Child B, Staff)
3. **Go to "View Sent Requests"** screen
4. **Verify**: Only shows requests for currently active profile
5. **Switch profile** in dropdown
6. **Verify**: List updates to show only new profile's requests
7. **Check console logs**:
   ```
   Load requests error: (should be none)
   Filtered data: [array of requests matching active profile]
   ```

---

## Database Schema Reference

### ChildRideRequest
```prisma
model ChildRideRequest {
  id           Int           @id @default(autoincrement())
  childId      Int
  driverId     Int
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt          // Auto-managed
  Amount       Float?
  AssignedDate DateTime?
  status       RequestStatus @default(Pending)
  child        Child         @relation(fields: [childId], references: [child_id])
  driver       Driver        @relation(fields: [driverId], references: [driver_id])
}
```

### StaffRideRequest
```prisma
model StaffRideRequest {
  id              Int             @id @default(autoincrement())
  staffId         Int
  driverId        Int
  status          RequestStatus   @default(Pending)
  Amount          Float?
  AssignedDate    DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime                        // Must be provided
  Driver          Driver          @relation(fields: [driverId], references: [driver_id])
  Staff_Passenger Staff_Passenger @relation(fields: [staffId], references: [id])
}
```

### RequestStatus Enum
```prisma
enum RequestStatus {
  Pending
  Assigned
  Unassigned
  Rejected
}
```

---

## Files Modified

1. ✅ `backend/src/driver-request/driver-request.service.ts` - Fixed assignRequest method
2. ✅ `mobile-customer/app/(menu)/find-driver/request-list.tsx` - Added profile filtering

---

## Notes

- **Line Ending Warnings**: The backend file has cosmetic ESLint warnings about CRLF line endings. These don't affect functionality.
- **Type Safety**: Pre-existing TypeScript warnings about `any` types remain but are unrelated to our changes.
- **Profile ID Format**: Customer app uses composite IDs like "child-123" or "staff-456", while backend uses numeric IDs.
- **Backward Compatibility**: Changes are backward compatible - no migration needed.
